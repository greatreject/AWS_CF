AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Version : 3.2
  Last changed : 11-11-20
  This template creates:
  VPC with 3 Tiers (Tier 1 -Public, Tier 2 - Application and Tier 3 -Database) with the option to create a Tier 2 Mgt subnet
  across two AZ's
  with NAT Gateways across 2 AZ's

Metadata:
  Stack:
    Value: 0
  VersionDate:
    Value: 20190725
  Identifier:
    Value: main
  Input:
    Description: Input of all required parameters in the stack
  Output:
    Description: N/A
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: General Configuration
      Parameters:
      - AvailabilityZones
      - Environment
      - NameofRegion
      - EngieAccountID
      - EngieVPCID
    - Label:
        default: Network Configuration
      Parameters:
      - VPCCIDR
      - PublicSubnetACIDR
      - PublicSubnetBCIDR
      - PrivateSubnetACIDR
      - PrivateSubnetBCIDR
      - MgtSubnet      
      - MgtSubnetACIDR
      - MgtSubnetBCIDR
      - SecuredSubnetACIDR
      - SecuredSubnetBCIDR  
      - InternetGateway
      - VPCTenancy
    - Label:
        default: Optional Features
      Parameters:
      - NATGateway
      - FlowLog
    - Label:
        default: Business Identification
      Parameters:
      - BusinessUnit
      - CostCenter
    ParameterLabels:
      AvailabilityZones:
        default: Availability Zones
      Environment:
        default: Environment
      NameofRegion:
        default: Region
      EngieVPCID:
        default: ENGIE VPC ID
      VPCCIDR:
        default: VPC CIDR
      PublicSubnetACIDR:
        default: Tier 1 - Public - Subnet AZ-A CIDR - (Internet, only HTTP and HTTPS for Inbound traffic)
      PublicSubnetBCIDR:
        default: Tier 1 - Public - Subnet AZ-B CIDR - (Internet, only HTTP and HTTPS for Inbound traffic)
      PrivateSubnetACIDR:
        default: Tier 2 - Private - Subnet AZ-A CIDR (Application)
      PrivateSubnetBCIDR:
        default: Tier 2 - Private - Subnet AZ-B CIDR (Application)
      MgtSubnet:
        default: Create a Management Subnet (Optional)
      MgtSubnetACIDR:
        default: Tier 2 - Private - Subnet AZ-A CIDR (Management)
      MgtSubnetBCIDR:
        default: Tier 2 - Private - Subnet AZ-B CIDR (Management)
      SecuredSubnetACIDR:
        default: Tier 3 - Private - Subnet AZ-A CIDR (Database)
      SecuredSubnetBCIDR:
        default: Tier 3 - Private - Subnet AZ-B CIDR (Database)
      InternetGateway:
        default: Internet gateway ID
      NATGateway:
        default: Install a NAT Gateway
      FlowLog:
        default: Install FlowLog        
      VPCTenancy:
        default: VPC Tenancy
      Owner:
        default: VPC Created by
      BusinessUnit:
        default: Business Unit identifiers
      CostCenter:
        default: Cost Center

Parameters:
  AvailabilityZones:
    Description: 'List of Availability Zones to use for the subnets in the VPC.
      Note:The logical order is preserved. Use only 2 AZs!'
    Type: List<AWS::EC2::AvailabilityZone::Name>
  Environment:
    Description: 'Environment type Production = prd; Development = dev; Pre Production = uat'
    AllowedValues:
    - prd
    - dev
    - uat
    Type: String
    Default: dev
  NameofRegion:
    Description: 'Region value used in Name tags string : Ireland = euw1; United Kingdom = euw2"  (example : igw-euw1-dev-xxx)'
    Type: String
    Default: euw2
  EngieVPCID:
    Description: 'ENGIE allocated VPC ID"   (example : es01)'
    Type: String
    Default: xx01
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/22
    Description: CIDR block for the VPC
    Type: String
  PublicSubnetACIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/25
    Description: "CIDR block for the public DMZ subnet located in Availability Zone A"
    Type: String
  PublicSubnetBCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.128/25
    Description: "CIDR block for the public DMZ subnet located in Availability Zone B"
    Type: String
  PrivateSubnetACIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.2.0/24
    Description: "CIDR block for Tier 2 private subnet located in Availability Zone A"
    Type: String
  PrivateSubnetBCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.3.0/24
    Description: "CIDR block for Tier 2 private subnet located in Availability Zone B"
    Type: String
  MgtSubnet:
    AllowedValues:
    - Create Management Subnet
    - No Management Subnet
    Default: No Management Subnet
    Description: "Install a Management Subnet in each AZ"
    Type: String
  MgtSubnetACIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.1.0/25
    Description: "CIDR block for Tier 2 private Management subnet located in Availability Zone A"
    Type: String
  MgtSubnetBCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.1.128/25
    Description: "CIDR block for Tier 2 private Management subnet located in Availability Zone B"
    Type: String
  SecuredSubnetACIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.1.0/25
    Description: "CIDR block for Tier 3 private subnet located in Availability Zone A"
    Type: String
  SecuredSubnetBCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.1.128/25
    Description: "CIDR block for Tier 3 private subnet located in Availability Zone B"
    Type: String
  VPCTenancy:
    AllowedValues:
    - default
    - dedicated
    Default: default
    Description: "The allowed tenancy of instances launched into the VPC"
    Type: String
  NATGateway:
    AllowedValues:
    - Install NAT Gateway
    - No NAT Gateway
    Default: Install NAT Gateway
    Description: "Install a NAT Gateway in each AZ"
    Type: String
  FlowLog:
    AllowedValues:
    - Install FlowLog
    - No FlowLog
    Default: Install FlowLog
    Description: "Install FlowLog for this VPC"
    Type: String
  Owner:
    Description: "VPC Created by"
    Default: Name
    Type: String
  BusinessUnit:
    Description: "Business Unit identifiers"
    Default: BU07
    Type: String
  CostCenter:
    Description: "Cost Center for Billing"
    Default: HQ - ENGIE UK
    Type: String

Conditions: 
  CreateResource1: !Equals [ !Ref NATGateway, Install NAT Gateway ]
  CreateResource2: !Equals [ !Ref FlowLog, Install FlowLog ]
  CreateResource3: !Equals [ !Ref MgtSubnet, Create Management Subnet ]
  CreateResource4: !And [!Equals [ !Ref NATGateway, Install NAT Gateway ], !Equals [ !Ref MgtSubnet, Create Management Subnet ]]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: VPCCIDR
      InstanceTenancy:
        Ref: VPCTenancy
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - vpc
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - Ref: EngieVPCID                             
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
       
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - igw
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - Ref: EngieVPCID   
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway
  ### PUBLIC SUBNETS
  ### SBN - PUBLIC SUBNETS - TIER 1
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: PublicSubnetACIDR
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - pub
            - "-"
            - t1
            - "-"
            - Ref: EngieVPCID           
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: PublicSubnetBCIDR
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - pub
            - "-"
            - t1
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PublicSubnetRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - rtb
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - pub
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PublicSubnetRoute:
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PublicSubnetRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnetA
      RouteTableId:
        Ref: PublicSubnetRouteTable
  PublicSubnetNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - acl
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - pub
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PublicSubnetANetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnetA
      NetworkAclId:
        Ref: PublicSubnetNetworkAcl
  PublicSubnetBNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnetB
      NetworkAclId:
        Ref: PublicSubnetNetworkAcl
  ### INBOUND traffic Network Access Lists - PUBLIC SUBNETS
  # Allows Inbound HTTP traffic from the Internet to the Public subnet.
  NACLRuleAllowHTTPIngressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      Protocol: 6
      PortRange:
        From: 80
        To: 80
      RuleAction: allow
      RuleNumber: 100
      NetworkAclId: !Ref PublicSubnetNetworkAcl
  # Allows Inbound HTTPS traffic from the Internet to the Public subnet.
  NACLRuleAllowHTTPSIngressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      Protocol: 6
      PortRange:
        From: 443
        To: 443
      RuleAction: allow
      RuleNumber: 110
      NetworkAclId: !Ref PublicSubnetNetworkAcl
  # Allows Inbound traffic for unprivileged port to the Public subnet.      
  NACLRuleAllowCustomTCPIngressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      Protocol: 6
      PortRange:
        From: 1025
        To: 65535
      RuleAction: allow
      RuleNumber: 120
      NetworkAclId: !Ref PublicSubnetNetworkAcl
  ### OUTBOUND traffic Network Access Lists
  # Allows outbound HTTP traffic from the public subnet to the Internet.
  NACLRuleAllowHTTPEgressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      Protocol: 6
      PortRange:
        From: 80
        To: 80
      RuleAction: allow
      RuleNumber: 200
      NetworkAclId: !Ref PublicSubnetNetworkAcl      
  # Allows outbound HTTPS traffic from the subnet to the Internet.
  NACLRuleAllowHTTPSEgressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      Protocol: 6
      PortRange:
        From: 443
        To: 443
      RuleAction: allow
      RuleNumber: 210
      NetworkAclId: !Ref PublicSubnetNetworkAcl
  # Allows outbound return traffic from public subnets for requests originating from Internet.
  NACLRuleAllowCustomTCPEgressPublic:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      Protocol: 6
      PortRange:
        From: 1025
        To: 65535
      RuleAction: allow
      RuleNumber: 220
      NetworkAclId: !Ref PublicSubnetNetworkAcl

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnetB
      RouteTableId:
        Ref: PublicSubnetRouteTable

  ### PRIVATE SUBNETS
  ### SBN - PRIVATE SUBNETS - TIER 2
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: PrivateSubnetACIDR
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: PrivateSubnetBCIDR
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PrivateSubnetRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - rtb
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PrivateSubnetRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - rtb
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - prv
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnetA
      RouteTableId:
        Ref: PrivateSubnetRouteTableA
  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnetB
      RouteTableId:
        Ref: PrivateSubnetRouteTableB
  ### Network Access Lists - PRIVATE - TIER 2  
  PrivateSubnetNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - acl
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  PrivateSubnetANetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnetA
      NetworkAclId:
        Ref: PrivateSubnetNetworkAcl
  PrivateSubnetBNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnetB
      NetworkAclId:
        Ref: PrivateSubnetNetworkAcl
  ### INBOUND TRAFFIC - PRIVATE TIER 2 SUBNETS
  PrivateSubnetNetworkAclEntryInbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      NetworkAclId:
        Ref: PrivateSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'
  ### OUTBOUND TRAFFIC - PRIVATE TIER 2 SUBNETS
  PrivateSubnetNetworkAclEntryOutbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      NetworkAclId:
        Ref: PrivateSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'

  ### PRIVATE SUBNETS
  ### SBN - PRIVATE SUBNETS - TIER 3
  SecuredSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: SecuredSubnetACIDR
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - t3
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  SecuredSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: SecuredSubnetBCIDR
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - prv
            - "-"
            - t3
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  SecuredSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: SecuredSubnetA
      RouteTableId:
        Ref: PrivateSubnetRouteTableA
  SecuredSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: SecuredSubnetB
      RouteTableId:
        Ref: PrivateSubnetRouteTableB
  ### Network Access Lists - PRIVATE - TIER 3   
  SecuredSubnetNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - acl
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - prv
            - "-"
            - t3
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  SecuredSubnetANetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: SecuredSubnetA
      NetworkAclId:
        Ref: SecuredSubnetNetworkAcl
  SecuredSubnetBNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId:
        Ref: SecuredSubnetB
      NetworkAclId:
        Ref: SecuredSubnetNetworkAcl
  ### INBOUND TRAFFIC - PRIVATE TIER 3 SUBNETS
  SecuredSubnetNetworkAclEntryInbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      NetworkAclId:
        Ref: SecuredSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'
  ### OUTBOUND TRAFFIC - PRIVATE TIER 3 SUBNETS
  SecuredSubnetBNetworkAclEntryOutbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      NetworkAclId:
        Ref: SecuredSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'

  ### MANAGEMENT SUBNETS (Optional)
  ### SBN - MANAGEMENT SUBNETS - TIER 2
  MgtSubnetA:
    Type: AWS::EC2::Subnet
    Condition: CreateResource3
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: MgtSubnetACIDR
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - mgt
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  MgtSubnetB:
    Type: AWS::EC2::Subnet
    Condition: CreateResource3
    Properties:
      VpcId:
        Ref: VPC
      CidrBlock:
        Ref: MgtSubnetBCIDR
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Ref: AvailabilityZones
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - sbn
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - mgt
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  ### RTB - MANAGEMENT SUBNETS - ROUTE TABLES
  MgtSubnetRouteTableA:
    Type: AWS::EC2::RouteTable
    Condition: CreateResource3
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - rtb
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - prv
            - "-"
            - mgt
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  MgtSubnetRouteTableB:
    Type: AWS::EC2::RouteTable
    Condition: CreateResource3
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - rtb
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - prv
            - "-"
            - mgt
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  MgtSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateResource3
    Properties:
      SubnetId:
        Ref: MgtSubnetA
      RouteTableId:
        Ref: MgtSubnetRouteTableA
  MgtSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateResource3
    Properties:
      SubnetId:
        Ref: MgtSubnetB
      RouteTableId:
        Ref: MgtSubnetRouteTableB
  ### NACL - MANAGEMENT SUBNETS - INBOUND & OUTBOUND TRAFFIC
  MgtSubnetNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Condition: CreateResource3
    Properties:
      VpcId:
        Ref: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - acl
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - prv
            - "-"
            - t2
            - "-"
            - mgt
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter
  MgtSubnetANetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: CreateResource3
    Properties:
      SubnetId:
        Ref: MgtSubnetA
      NetworkAclId:
        Ref: MgtSubnetNetworkAcl
  MgtSubnetBNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Condition: CreateResource3
    Properties:
      SubnetId:
        Ref: MgtSubnetB
      NetworkAclId:
        Ref: MgtSubnetNetworkAcl
  MgtSubnetNetworkAclEntryInbound:
    Type: AWS::EC2::NetworkAclEntry
    Condition: CreateResource3
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'false'
      NetworkAclId:
        Ref: MgtSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'
  MgtSubnetNetworkAclEntryOutbound:
    Type: AWS::EC2::NetworkAclEntry
    Condition: CreateResource3
    Properties:
      CidrBlock: 0.0.0.0/0
      Egress: 'true'
      NetworkAclId:
        Ref: MgtSubnetNetworkAcl
      Protocol: '-1'
      RuleAction: allow
      RuleNumber: '100'

  ### NAT Gateway Configuration
  EIPNatGWazA:
    Type: AWS::EC2::EIP
    Condition: CreateResource1
    Properties:
      Domain: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - eip
            - "-"            
            - nat
            - "-"
            - aza
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter             
  NatGWazA:
    Type: AWS::EC2::NatGateway
    Condition: CreateResource1
    DependsOn: EIPNatGWazA
    Properties:
      AllocationId:
        Fn::GetAtt:
          - EIPNatGWazA
          - AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - nat
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - aza
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter 
  EIPNatGWazB:
    Type: AWS::EC2::EIP
    Condition: CreateResource1
    Properties:
      Domain: VPC
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - eip
            - "-"            
            - nat
            - "-"
            - azb
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter           
  NatGWazB:
    Type: AWS::EC2::NatGateway
    Condition: CreateResource1
    DependsOn: EIPNatGWazB
    Properties:
      AllocationId:
        Fn::GetAtt:
          - EIPNatGWazB
          - AllocationId
      SubnetId: !Ref PublicSubnetB
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - ''
          - - nat
            - "-"            
            - Ref: NameofRegion
            - "-"
            - Ref: Environment
            - "-"
            - azb
            - "-"
            - Ref: EngieVPCID            
      - Key: Owner
        Value:
          Ref: Owner  
      - Key: Business Unit
        Value:
          Ref: BusinessUnit
      - Key: Cost Center
        Value:
          Ref: CostCenter 
  PrivateSubnetRouteA:
    Type: AWS::EC2::Route
    Condition: CreateResource1
    DependsOn: NatGWazA
    Properties:
      RouteTableId:
        Ref: PrivateSubnetRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGWazA
      RouteTableId: !Ref PrivateSubnetRouteTableA
  PrivateSubnetRouteB:
    Type: AWS::EC2::Route
    Condition: CreateResource1
    DependsOn: NatGWazB
    Properties:
      RouteTableId:
        Ref: PrivateSubnetRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGWazB
      RouteTableId: !Ref PrivateSubnetRouteTableB
  MgtSubnetRouteA:
    Type: AWS::EC2::Route
    Condition: CreateResource4
    DependsOn: NatGWazA
    Properties:
      RouteTableId:
        Ref: MgtSubnetRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGWazA
      RouteTableId: !Ref MgtSubnetRouteTableA
  MgtSubnetRouteB:
    Type: AWS::EC2::Route
    Condition: CreateResource4
    DependsOn: NatGWazB
    Properties:
      RouteTableId:
        Ref: MgtSubnetRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGWazB
      RouteTableId: !Ref MgtSubnetRouteTableB
      
  ### FLOWLOG
  FlowLogLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateResource2
    Properties:
      LogGroupName:
        Fn::Sub: Vpc-FlowAll-${AWS::StackName}
      RetentionInDays: 90
  FlowLogCWLPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: CreateResource2
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Action:
              - "logs:CreateLogGroup"
              - "logs:CreateLogStream"
              - "logs:PutLogEvents"
              - "logs:DescribeLogGroups"
              - "logs:DescribeLogStreams"
            Resource: !GetAtt FlowLogLogGroup.Arn

  FlowLogCWLRole:
    Type: AWS::IAM::Role
    Condition: CreateResource2
    Properties:
      Path: "/"
      ManagedPolicyArns:
        - !Ref FlowLogCWLPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "vpc-flow-logs.amazonaws.com"
            Action:
              - "sts:AssumeRole"
  DefaultFlowLog:
    Type: "AWS::EC2::FlowLog"
    Condition: CreateResource2
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogCWLRole.Arn
      LogGroupName:
        Ref: FlowLogLogGroup
      ResourceId:
        Ref: VPC
      ResourceType: VPC
      TrafficType: ALL


Outputs:
  PrivateSubnetACIDR:
    Description: Private subnet CIDR in Availability Zone A
    Value:
      Ref: PrivateSubnetACIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetACIDR
  PrivateSubnetAID:
    Description: Private subnet ID in Availability Zone A
    Value:
      Ref: PrivateSubnetA
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetAID
  PrivateSubnetBID:
    Description: Private subnet ID in Availability Zone B
    Value:
      Ref: PrivateSubnetB
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetBID
  PrivateSubnetBCIDR:
    Description: Private subnet CIDR in Availability Zone B
    Value:
      Ref: PrivateSubnetBCIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetBCIDR
  MgtSubnetAID:
    Condition: CreateResource3
    Description: Management subnet ID in Availability Zone A
    Value:
      Ref: MgtSubnetA
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetAID
  MgtSubnetACIDR:
    Condition: CreateResource3
    Description: Management subnet CIDR in Availability Zone A
    Value:
      Ref: MgtSubnetACIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetACIDR
  MgtSubnetBID:
    Condition: CreateResource3
    Description: Management subnet ID in Availability Zone B
    Value:
      Ref: MgtSubnetB
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetBID
  MgtSubnetBCIDR:
    Condition: CreateResource3
    Description: Management subnet CIDR in Availability Zone B
    Value:
      Ref: MgtSubnetBCIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetBCIDR
  SecuredSubnetACIDR:
    Description: Secure subnet CIDR in Availability Zone A
    Value:
      Ref: SecuredSubnetACIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SecuredSubnetACIDR
  SecuredSubnetAID:
    Description: Secure subnet ID in Availability Zone A
    Value:
      Ref: SecuredSubnetA
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SecuredSubnetAID
  SecuredSubnetBCIDR:
    Description: Secure subnet CIDR in Availability Zone B
    Value:
      Ref: SecuredSubnetBCIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SecuredSubnetBCIDR
  PublicSubnetACIDR:
    Description: Public subnet CIDR in Availability Zone A
    Value:
      Ref: PublicSubnetACIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicSubnetACIDR
  PublicSubnetAID:
    Description: Public subnet ID in Availability Zone A
    Value:
      Ref: PublicSubnetA
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicSubnetAID
  PublicSubnetBCIDR:
    Description: Public subnet CIDR in Availability Zone B
    Value:
      Ref: PublicSubnetBCIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicSubnetBCIDR
  PublicSubnetBID:
    Description: Public subnet ID in Availability Zone B
    Value:
      Ref: PublicSubnetB
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicSubnetBID
  PrivateSubnetRouteTableA:
    Value:
      Ref: PrivateSubnetRouteTableA
    Description: Private subnet route table A
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetRouteTableA
  PrivateSubnetRouteTableB:
    Value:
      Ref: PrivateSubnetRouteTableB
    Description: Private subnet route table B
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrivateSubnetRouteTableB
  MgtSubnetRouteTableA:
    Condition: CreateResource3
    Value:
      Ref: MgtSubnetRouteTableA
    Description: Management subnet route table A
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetRouteTableA
  MgtSubnetRouteTableB:
    Condition: CreateResource3
    Value:
      Ref: MgtSubnetRouteTableB
    Description: Management subnet route table B
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-MgtSubnetRouteTableB 
  PublicSubnetRouteTable:
    Value:
      Ref: PublicSubnetRouteTable
    Description: Public subnet route table
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PublicSubnetRouteTable
  VPCCIDR:
    Value:
      Ref: VPCCIDR
    Description: VPC CIDR
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-VPCCIDR
  VPCID:
    Value:
      Ref: VPC
    Description: VPC ID
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-VPCID
